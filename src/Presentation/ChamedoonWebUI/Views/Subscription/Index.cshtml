@model ChamedoonWebUI.Models.SubscriptionPageViewModel
@using System.Linq
@using Chamedoon.Application.Services.Subscription
@{
    ViewData["Title"] = "انتخاب اشتراک";
    string PlanAccent(int index) => index switch
    {
        0 => "plan-card--basic",
        1 => "plan-card--pro",
        _ => "plan-card--elite"
    };
    string PlanHighlight(int index, SubscriptionPlan plan) => index switch
    {
        0 => "۳ استعلام",
        1 => "استعلام بی نهایت",
        _ => "استعلام بی نهایت"
    };
    string[] PlanBullets(int index, SubscriptionPlan plan) => index switch
    {
        0 => new[] { "۳ استعلام" },
        1 => new[] { "استعلام بی نهایت" },
        _ => new[] { "استعلام بی نهایت", "هوش مصنوعی برای نتیجه بهتر" }
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/subscription.css" asp-append-version="true" />
}

<section class="subscription-screen py-5 py-lg-6">
    <div class="container">
        <div class="subscription-phone">
            <div class="subscription-phone__header">
                <span class="subscription-phone__hello">سلام! آماده‌ای ارزیابی رو شروع کنی؟</span>
                <h1>پلن دلخواهت رو انتخاب کن</h1>
                <p>پلن‌ها همه یک‌ماهه هستند و با تخفیف فعال می‌شوند.</p>
            </div>
            <div class="subscription-phone__status">
                <p class="status-title">اشتراک فعلی</p>
                @if (Model.CurrentSubscription is null)
                {
                    <p class="status-plan text-muted mb-1">اشتراکی فعال نیست.</p>
                    <p class="status-meta mb-0">یکی از پلن‌ها را انتخاب کن.</p>
                }
                else
                {
                    <p class="status-plan">@Model.CurrentSubscription.PlanTitle</p>
                    <p class="status-meta mb-1">@Model.CurrentSubscription.RemainingDays روز باقی‌مانده</p>
                    @if (Model.CurrentSubscription.EvaluationLimit is null)
                    {
                        <p class="status-meta mb-0">استعلام بی‌نهایت</p>
                    }
                    else
                    {
                        <p class="status-meta mb-0">@Model.CurrentSubscription.UsedEvaluations از @Model.CurrentSubscription.EvaluationLimit</p>
                    }
                }
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.AlertMessage))
        {
            <div class="alert alert-info subscription-alert" role="alert">
                @Model.AlertMessage
            </div>
        }

        <div class="plan-carousel" role="list">
            @for (var index = 0; index < Model.Plans.Count; index++)
            {
                var plan = Model.Plans[index];
                var isCurrent = Model.CurrentSubscription?.PlanId == plan.Id;
                var accent = PlanAccent(index);
                var highlight = PlanHighlight(index, plan);
                var bullets = PlanBullets(index, plan);
                <article class="plan-card @accent @(isCurrent ? "plan-card--active" : string.Empty)" role="listitem">
                    <header class="plan-card__header">
                        <div>
                            <p class="plan-card__eyebrow">@plan.Title</p>
                            <h3>@highlight</h3>
                        </div>
                        <div class="plan-card__price">
                            <span class="plan-card__current">@plan.Price.ToString("N0") <small>تومان</small></span>
                            <span class="plan-card__old">@plan.OriginalPrice.ToString("N0")</span>
                        </div>
                    </header>
                    <ul class="plan-card__bullets">
                        @foreach (var bullet in bullets)
                        {
                            <li>@bullet</li>
                        }
                    </ul>
                    <div class="plan-card__cta">
                        <span class="plan-card__discount">@plan.SavingsAmount.ToString("N0") تومان کمتر</span>
                        <form asp-action="Subscribe" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="planId" value="@plan.Id" />
                            <button type="submit" class="btn btn-light" @(isCurrent ? "disabled" : string.Empty)>
                                @(isCurrent ? "فعال شده" : "انتخاب پلن")
                            </button>
                        </form>
                    </div>
                </article>
            }
        </div>
    </div>
</section>
