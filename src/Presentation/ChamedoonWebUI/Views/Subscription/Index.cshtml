@model ChamedoonWebUI.Models.SubscriptionPageViewModel
@using System.Linq
@using Chamedoon.Application.Services.Subscription
@{ 
    ViewData["Title"] = "انتخاب اشتراک";
    string PlanAccent(int index) => index switch
    {
        0 => "plan-showcase--basic",
        1 => "plan-showcase--pro",
        _ => "plan-showcase--elite"
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/subscription.css" asp-append-version="true" />
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const globalDiscount = document.getElementById('global-discount');
            const applyButton = document.getElementById('apply-discount');
            const previewStatus = document.getElementById('discount-feedback');
            const planDiscountInputs = document.querySelectorAll('.plan-discount');
            const previewUrl = '@Url.Action("PreviewDiscount", "Subscription")';

            if (!globalDiscount || !applyButton) return;

            const planCards = Array.from(document.querySelectorAll('.plan-showcase')).map(card => {
                const planId = card.dataset.planId;
                const priceEl = card.querySelector('.plan-showcase__price');
                const badgeEl = card.querySelector('.plan-showcase__badge');
                const previewEl = card.querySelector('.plan-showcase__preview');

                return {
                    planId,
                    priceEl,
                    badgeEl,
                    previewEl,
                    baseAmount: parseInt(priceEl?.dataset.amount ?? '0') || 0,
                    baseBadge: badgeEl?.textContent?.trim() ?? ''
                };
            });

            const formatCurrency = (value) => value.toLocaleString('fa-IR') + ' تومان';

            const syncDiscounts = () => {
                planDiscountInputs.forEach(input => input.value = globalDiscount.value);
            };

            const resetPreview = () => {
                planCards.forEach(card => {
                    if (card.priceEl) {
                        card.priceEl.textContent = formatCurrency(card.baseAmount);
                    }

                    if (card.badgeEl && card.baseBadge) {
                        card.badgeEl.textContent = card.baseBadge;
                    }

                    if (card.previewEl) {
                        card.previewEl.classList.add('d-none');
                    }
                });

                previewStatus.textContent = '';
                previewStatus.classList.remove('text-success', 'text-danger');
            };

            const updatePreview = (result) => {
                resetPreview();
                if (!result || !Array.isArray(result.plans)) {
                    return;
                }

                result.plans.forEach(plan => {
                    const card = planCards.find(c => c.planId === plan.planId);
                    if (!card) return;

                    if (card.priceEl) {
                        card.priceEl.textContent = formatCurrency(plan.finalAmount);
                    }

                    if (card.previewEl) {
                        const discountLabel = card.previewEl.querySelector('[data-preview-discount]');
                        const finalLabel = card.previewEl.querySelector('[data-preview-final]');
                        if (discountLabel) {
                            discountLabel.textContent = plan.discountAmount > 0
                                ? plan.discountAmount.toLocaleString('fa-IR')
                                : '0';
                        }

                        if (finalLabel) {
                            finalLabel.textContent = formatCurrency(plan.finalAmount);
                        }

                        card.previewEl.classList.remove('d-none');
                    }
                });

                if (result.message) {
                    previewStatus.textContent = result.message;
                    previewStatus.classList.add(result.isValid ? 'text-success' : 'text-danger');
                }
            };

            applyButton.addEventListener('click', async () => {
                syncDiscounts();
                applyButton.disabled = true;
                applyButton.classList.add('is-loading');

                try {
                    const response = await fetch(previewUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ code: globalDiscount.value })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        updatePreview(result);
                    } else {
                        resetPreview();
                        previewStatus.textContent = 'بررسی کد تخفیف با خطا مواجه شد.';
                        previewStatus.classList.add('text-danger');
                    }
                } catch (e) {
                    resetPreview();
                    previewStatus.textContent = 'برقراری ارتباط با سرور ممکن نشد.';
                    previewStatus.classList.add('text-danger');
                } finally {
                    applyButton.disabled = false;
                    applyButton.classList.remove('is-loading');
                }
            });

            globalDiscount.addEventListener('input', () => {
                resetPreview();
                syncDiscounts();
            });

            syncDiscounts();
        });
    </script>
}

<section class="subscription-screen py-5 py-lg-6">
    <div class="container">


        @if (!string.IsNullOrWhiteSpace(Model.AlertMessage))
        {
            <div class="alert alert-info subscription-alert" role="alert">
                @Model.AlertMessage
            </div>
        }
        <div class="plan-showcase-grid" role="list">
            @for (var index = 0; index < Model.Plans.Count; index++)
            {
                var plan = Model.Plans[index];
                var isCurrent = Model.CurrentSubscription?.PlanId == plan.Id;
                var accent = PlanAccent(index);
                <article class="plan-showcase @accent @(isCurrent ? "plan-showcase--active" : string.Empty)" data-plan-id="@plan.Id" role="listitem">
                    <div class="plan-showcase__layer plan-showcase__layer--dark"></div>
                    <div class="plan-showcase__layer plan-showcase__layer--light"></div>
                    <div class="plan-showcase__content">
                        <header class="plan-showcase__header">
                            <div>
                                <p class="plan-showcase__eyebrow">@plan.DurationLabel</p>
                                <h3>@plan.Title</h3>
                            </div>
                            <div class="plan-showcase__pricing">
                                <span class="plan-showcase__price" data-amount="@plan.Price">@plan.Price.ToString("N0") تومان</span>
                                <span class="plan-showcase__original">@plan.OriginalPrice.ToString("N0") تومان</span>
                                <span class="plan-showcase__badge">@plan.DiscountPercent% تخفیف</span>
                                <div class="plan-showcase__preview d-none">
                                    <span class="plan-showcase__preview-label">کد تخفیف:</span>
                                    <span class="plan-showcase__preview-value" data-preview-discount>0</span>
                                    <span>تومان کمتر -</span>
                                    <strong data-preview-final>@plan.Price.ToString("N0") تومان</strong>
                                </div>
                            </div>
                        </header>

                        <ul class="plan-showcase__features">
                            @foreach (var feature in plan.Features)
                            {
                                <li>@feature</li>
                            }
                        </ul>

                        <div class="plan-showcase__footer">
                            <form asp-action="Subscribe" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="planId" value="@plan.Id" />
                                <input type="hidden" name="discountCode" class="plan-discount" value="@Model.DiscountCode" />
                                <button type="submit" class="btn-glass-primary btn-rounded" @(isCurrent ? "disabled" : string.Empty)>
                                    @(isCurrent ? "فعال شده" : "انتخاب پلن")
                                </button>
                            </form>
                        </div>
                    </div>
                </article>
            }
        </div>
        <br />
        <div class="subscription-hero">
            <div class="subscription-hero__discount">
                <label class="form-label" for="global-discount">کد تخفیف</label>
                <div class="discount-input-group">
                    <input id="global-discount"
                           type="text"
                           value="@Model.DiscountCode"
                           class="form-control"
                           placeholder="CHMDN10" />
                    <button type="button" class="btn btn-glass-primary" id="apply-discount">
                        <span class="apply-label">اعمال کد</span>
                        <span class="apply-spinner" aria-hidden="true"></span>
                    </button>
                </div>
                <p class="form-text" id="discount-feedback"></p>
            </div>
        </div>
    </div>
</section>
