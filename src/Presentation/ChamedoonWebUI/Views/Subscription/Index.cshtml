@model ChamedoonWebUI.Models.SubscriptionPageViewModel
@using System.Linq
@using Chamedoon.Application.Services.Subscription
@{ 
    ViewData["Title"] = "انتخاب اشتراک";
    string PlanAccent(int index) => index switch
    {
        0 => "plan-showcase--basic",
        1 => "plan-showcase--pro",
        _ => "plan-showcase--elite"
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/subscription.css" asp-append-version="true" />
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const paymentResult = {
                message: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.PaymentMessage)),
                success: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.PaymentSuccess)),
                returnUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReturnUrl))
            };
            const globalDiscount = document.getElementById('global-discount');
            const planDiscountInputs = document.querySelectorAll('.plan-discount');
            const planPriceElements = document.querySelectorAll('[data-plan-price]');
            const applyButton = document.getElementById('apply-discount-button');
            const discountFeedback = document.getElementById('discount-feedback');
            const numberFormatter = new Intl.NumberFormat('fa-IR');

            if (!globalDiscount) return;

            const formatMoney = (value) => `${numberFormatter.format(value)} تومان`;

            const syncDiscounts = (value) => {
                const syncedValue = value ?? globalDiscount.value;
                planDiscountInputs.forEach(input => input.value = syncedValue);
            };

            const updateFeedback = (message, type) => {
                if (!discountFeedback) return;
                discountFeedback.textContent = message || '';
                discountFeedback.classList.remove('discount-feedback--error', 'discount-feedback--success');

                if (type === 'error') {
                    discountFeedback.classList.add('discount-feedback--error');
                } else if (type === 'success') {
                    discountFeedback.classList.add('discount-feedback--success');
                }
            };

            const updatePlanDisplay = (planId, finalPrice, originalPrice, savings) => {
                const priceEl = document.querySelector(`[data-plan-price="${planId}"]`);
                const badgeEl = document.querySelector(`[data-plan-badge="${planId}"]`);
                const savingsEl = document.querySelector(`[data-plan-saving="${planId}"]`);
                const resolvedOriginalPrice = originalPrice > 0
                    ? originalPrice
                    : Number(priceEl?.dataset.originalPrice ?? finalPrice);

                if (priceEl) {
                    priceEl.textContent = formatMoney(finalPrice);
                }

                if (badgeEl && resolvedOriginalPrice > 0) {
                    const percent = Math.max(0, 100 - Math.round(finalPrice / resolvedOriginalPrice * 100));
                    badgeEl.textContent = percent > 0 ? `${percent}% تخفیف` : 'بدون تخفیف';
                }

                if (savingsEl) {
                    if (savings > 0) {
                        savingsEl.textContent = `صرفه‌جویی ${formatMoney(savings)} با کد تخفیف`;
                        savingsEl.hidden = false;
                    } else {
                        savingsEl.textContent = '';
                        savingsEl.hidden = true;
                    }
                }
            };

            const resetPlanDisplays = () => {
                planPriceElements.forEach(priceEl => {
                    const planId = priceEl.dataset.planPrice;
                    const basePrice = parseInt(priceEl.dataset.basePrice ?? '0', 10);
                    const originalPrice = parseInt(priceEl.dataset.originalPrice ?? `${basePrice}`, 10);
                    updatePlanDisplay(planId, basePrice, originalPrice, 0);
                });

                updateFeedback('', null);
                syncDiscounts(globalDiscount.value);
            };

            syncDiscounts();
            globalDiscount.addEventListener('input', () => syncDiscounts());

            applyButton?.addEventListener('click', async (event) => {
                event.preventDefault();
                const code = globalDiscount.value.trim();

                if (!code) {
                    resetPlanDisplays();
                    updateFeedback('کد تخفیف را وارد کن.', 'error');
                    return;
                }

                applyButton.disabled = true;
                applyButton.classList.add('is-loading');
                updateFeedback('در حال بررسی کد تخفیف...', null);

                try {
                    const response = await fetch('/subscriptions/apply-discount', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({ code })
                    });

                    const payload = await response.json().catch(() => null);

                    if (!response.ok || !payload) {
                        resetPlanDisplays();
                        updateFeedback(payload?.message || 'کد تخفیف معتبر نیست.', 'error');
                        return;
                    }

                    const appliedCode = payload.code ?? code;
                    const plans = payload.plans ?? [];

                    plans.forEach(plan => {
                        const planId = plan.planId || plan.PlanId;
                        const basePrice = Number(plan.basePrice ?? plan.BasePrice ?? 0);
                        const finalPrice = Number(plan.finalPrice ?? plan.FinalPrice ?? basePrice);
                        const originalPrice = Number(plan.originalPrice ?? plan.OriginalPrice ?? basePrice);
                        const savings = Number(plan.discountAmount ?? plan.DiscountAmount ?? 0);
                        updatePlanDisplay(planId, finalPrice, originalPrice, savings);
                    });

                    globalDiscount.value = appliedCode;
                    syncDiscounts(appliedCode);
                    updateFeedback(payload.message || 'کد تخفیف اعمال شد.', 'success');
                } catch {
                    resetPlanDisplays();
                    updateFeedback('خطا در برقراری ارتباط. دوباره تلاش کن.', 'error');
                } finally {
                    applyButton.disabled = false;
                    applyButton.classList.remove('is-loading');
                }
            });

            const showPaymentResultModal = () => {
                if (!paymentResult.message) return;

                const isSuccess = paymentResult.success === true;
                const isFailure = !isSuccess;
                const fallbackMessage = isFailure
                    ? 'پرداخت تایید نشد.'
                    : 'پرداخت با موفقیت انجام شد.';

                const modalElement = document.getElementById('paymentResultModal');
                if (!modalElement || typeof bootstrap === 'undefined') return;

                modalElement.setAttribute('data-return-url', paymentResult.returnUrl ?? '');
                modalElement.classList.toggle('payment-result-modal--success', isSuccess);
                modalElement.classList.toggle('payment-result-modal--failure', isFailure);

                const titleEl = modalElement.querySelector('[data-role="payment-title"]');
                const messageEl = modalElement.querySelector('[data-role="payment-message"]');
                const continueBtn = modalElement.querySelector('[data-role="payment-continue"]');

                if (titleEl) {
                    titleEl.textContent = isFailure ? 'پرداخت ناموفق' : 'پرداخت موفق';
                }

                if (messageEl) {
                    messageEl.textContent = paymentResult.message || fallbackMessage;
                }

                if (continueBtn) {
                    continueBtn.addEventListener('click', () => {
                        const destination = paymentResult.returnUrl || '/';
                        window.location.href = destination;
                    }, { once: true });
                }

                const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement, {
                    backdrop: 'static',
                    keyboard: false
                });
                modalInstance.show();
            };

            showPaymentResultModal();
        });
    </script>
}

<section class="subscription-screen py-5 py-lg-6">
    <div class="container">


        @if (!string.IsNullOrWhiteSpace(Model.AlertMessage))
        {
            <div class="alert alert-info subscription-alert" role="alert">
                @Model.AlertMessage
            </div>
        }
        <div class="plan-showcase-grid" role="list">
            @for (var index = 0; index < Model.Plans.Count; index++)
            {
                var plan = Model.Plans[index];
                var isCurrent = Model.CurrentSubscription?.PlanId == plan.Id;
                var accent = PlanAccent(index);
                <article class="plan-showcase @accent @(isCurrent ? "plan-showcase--active" : string.Empty)" role="listitem">
                    <div class="plan-showcase__layer plan-showcase__layer--dark"></div>
                    <div class="plan-showcase__layer plan-showcase__layer--light"></div>
                    <div class="plan-showcase__content">
                        <header class="plan-showcase__header">
                            <div>
                                <p class="plan-showcase__eyebrow">@plan.DurationLabel</p>
                                <h3>@plan.Title</h3>
                            </div>
                            <div class="plan-showcase__pricing">
                                <span class="plan-showcase__price" data-plan-price="@plan.Id" data-base-price="@plan.Price" data-original-price="@plan.OriginalPrice">@plan.Price.ToString("N0") تومان</span>
                                <span class="plan-showcase__original">@plan.OriginalPrice.ToString("N0") تومان</span>
                                <span class="plan-showcase__badge" data-plan-badge="@plan.Id">@plan.DiscountPercent% تخفیف</span>
                                <span class="plan-showcase__saving" data-plan-saving="@plan.Id" hidden></span>
                            </div>
                        </header>

                        <ul class="plan-showcase__features">
                            @foreach (var feature in plan.Features)
                            {
                                <li>@feature</li>
                            }
                        </ul>

                        <div class="plan-showcase__footer">
                            <form asp-action="Subscribe" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="planId" value="@plan.Id" />
                                <input type="hidden" name="discountCode" class="plan-discount" value="@Model.DiscountCode" />
                                <input type="hidden" name="returnUrl" value="@Model.ReturnUrl" />
                                <button type="submit" class="btn-glass-primary btn-rounded" @(isCurrent ? "disabled" : string.Empty)>
                                    @(isCurrent ? "فعال شده" : "انتخاب پلن")
                                </button>
                            </form>
                        </div>
                    </div>
                </article>
            }
        </div>
        <br />
        <div class="subscription-hero">
            <div class="subscription-hero__discount-row">
                <label class="subscription-hero__discount-label" for="global-discount">کد تخفیف</label>
                <input id="global-discount"
                       type="text"
                       value="@Model.DiscountCode"
                       class="form-control subscription-hero__discount-input"
                       placeholder="CHMDN10" />
                <button id="apply-discount-button" type="button" class="btn btn-primary btn-apply-discount">اعمال تخفیف</button>
            </div>
            <div id="discount-feedback" class="discount-feedback" aria-live="polite"></div>
        </div>
    </div>
</section>

<div class="modal fade" id="paymentResultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content payment-result-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title" data-role="payment-title">وضعیت پرداخت</h5>
            </div>
            <div class="modal-body">
                <div class="payment-result-modal__status">
                    <div class="payment-result-modal__icon" aria-hidden="true">
                        <span class="payment-result-modal__icon-success">✓</span>
                        <span class="payment-result-modal__icon-failure">!</span>
                    </div>
                    <div>
                        <p class="payment-result-modal__message mb-0" data-role="payment-message">@Model.PaymentMessage</p>
                        <p class="payment-result-modal__hint mb-0">برای ادامه به صفحه قبلی برمی‌گردی.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">بستن</button>
                <button type="button" class="btn btn-primary payment-result-modal__continue" data-role="payment-continue">ادامه</button>
            </div>
        </div>
    </div>
</div>
