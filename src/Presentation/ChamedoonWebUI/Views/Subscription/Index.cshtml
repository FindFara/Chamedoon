@model ChamedoonWebUI.Models.SubscriptionPageViewModel
@using System.Linq
@using System.Text.RegularExpressions
@using Chamedoon.Application.Services.Subscription
@{ 
    ViewData["Title"] = "انتخاب اشتراک";
    var hasPaymentResult = Model.PaymentSuccess.HasValue || !string.IsNullOrWhiteSpace(Model.PaymentMessage);
    var fallbackPaymentMessage = Model.PaymentSuccess switch
    {
        true => "پرداخت با موفقیت انجام شد.",
        false => "پرداخت تایید نشد.",
        _ => null
    };
    var resolvedPaymentMessage = hasPaymentResult
        ? (!string.IsNullOrWhiteSpace(Model.PaymentMessage) && !Regex.IsMatch(Model.PaymentMessage, "[A-Za-z]")
            ? Model.PaymentMessage
            : fallbackPaymentMessage ?? Model.PaymentMessage)
        : null;
    var paymentSuccessValue = Model.PaymentSuccess?.ToString().ToLower() ?? string.Empty;
    string PlanAccent(int index) => index switch
    {
        0 => "plan-showcase--basic",
        1 => "plan-showcase--pro",
        _ => "plan-showcase--elite"
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/subscription.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/views/subscription/index.js" asp-append-version="true"></script>
}

<section class="subscription-screen py-5 py-lg-6">
    <div class="container">
        <div id="subscriptionData"
             data-payment-message="@resolvedPaymentMessage"
             data-payment-success="@paymentSuccessValue"
             data-payment-return-url="@Model.ReturnUrl"
             data-payment-has-result="@hasPaymentResult.ToString().ToLower()"
             hidden></div>


        @if (!string.IsNullOrWhiteSpace(Model.AlertMessage))
        {
            <div class="alert alert-info subscription-alert" role="alert">
                @Model.AlertMessage
            </div>
        }
        <div class="plan-showcase-grid" role="list">
            @for (var index = 0; index < Model.Plans.Count; index++)
            {
                var plan = Model.Plans[index];
                var isCurrent = Model.CurrentSubscription?.PlanId == plan.Id;
                var accent = PlanAccent(index);
                <article class="plan-showcase @accent @(isCurrent ? "plan-showcase--active" : string.Empty)" role="listitem">
                    <div class="plan-showcase__layer plan-showcase__layer--dark"></div>
                    <div class="plan-showcase__layer plan-showcase__layer--light"></div>
                    <div class="plan-showcase__content">
                        <header class="plan-showcase__header">
                            <div>
                                <h3>@plan.Title</h3>
                            </div>
                            <div class="plan-showcase__pricing">
                                <span class="plan-showcase__price" data-plan-price="@plan.Id" data-base-price="@plan.Price" data-original-price="@plan.OriginalPrice">@plan.Price.ToString("N0") تومان</span>
                                <span class="plan-showcase__original">@plan.OriginalPrice.ToString("N0") تومان</span>
                                <span class="plan-showcase__badge" data-plan-badge="@plan.Id">@plan.DiscountPercent% تخفیف</span>
                                <span class="plan-showcase__saving" data-plan-saving="@plan.Id" hidden></span>
                            </div>
                        </header>

                        <ul class="plan-showcase__features">
                            @foreach (var feature in plan.Features)
                            {
                                <li>@feature</li>
                            }
                        </ul>

                        <div class="plan-showcase__footer">
                            <form asp-action="Subscribe" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="planId" value="@plan.Id" />
                                <input type="hidden" name="discountCode" class="plan-discount" value="@Model.DiscountCode" />
                                <input type="hidden" name="returnUrl" value="@Model.ReturnUrl" />
                                <button type="submit" class="btn-glass-primary btn-rounded" @(isCurrent ? "disabled" : string.Empty)>
                                    @(isCurrent ? "فعال شده" : "انتخاب ")
                                </button>
                            </form>
                        </div>
                    </div>
                </article>
            }
        </div>
        <br />
        <div class="subscription-hero">
            <div class="subscription-hero__discount-row">
                <label class="subscription-hero__discount-label" for="global-discount">کد تخفیف</label>
                <input id="global-discount"
                       type="text"
                       value="@Model.DiscountCode"
                       class="form-control subscription-hero__discount-input"
                       placeholder="CHMDN10" />
                <button id="apply-discount-button" type="button" class="btn btn-primary btn-apply-discount">اعمال تخفیف</button>
            </div>
            <div id="discount-feedback" class="discount-feedback" aria-live="polite"></div>
        </div>
    </div>
</section>

<div class="modal fade" id="paymentResultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered payment-result-modal__dialog">
        <div class="modal-content payment-result-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title" data-role="payment-title">وضعیت پرداخت</h5>
            </div>
            <div class="modal-body">
                <div class="payment-result-modal__status">
                    <div class="payment-result-modal__icon" aria-hidden="true">
                        <span class="payment-result-modal__icon-success">✓</span>
                        <span class="payment-result-modal__icon-failure">✕</span>
                    </div>
                    <div>
                        <p class="payment-result-modal__message mb-0" data-role="payment-message">@Model.PaymentMessage</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">بستن</button>
                <button type="button" class="btn btn-primary payment-result-modal__continue" data-role="payment-continue">ادامه</button>
            </div>
        </div>
    </div>
</div>
