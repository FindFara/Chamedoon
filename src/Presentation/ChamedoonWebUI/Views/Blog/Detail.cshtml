@model Chamedoon.Application.Services.Blog.ViewModel.ArticleViewModel
@using ChamedoonWebUI.Models
@{ 
    ViewData["Title"] = Model.ArticleTitle;
    var fallbackBlogImage = Url.Content("~/img/blog-placeholder.svg");
    var heroImage = string.IsNullOrWhiteSpace(Model.ArticleImageName)
        ? fallbackBlogImage
        : (Model.ArticleImageName!.StartsWith("data:image", System.StringComparison.OrdinalIgnoreCase)
            || Model.ArticleImageName.StartsWith("http", System.StringComparison.OrdinalIgnoreCase))
            ? Model.ArticleImageName
            : Url.Content($"~/images/blog/{Model.ArticleImageName}"));
}

@section Styles {
    <link rel="stylesheet" href="~/css/persian-datepicker.css" asp-append-version="true" />
}

<section class="glass-section">
    <div class="container">
        <div class="row g-4 g-xl-5 blog-detail-layout">
            <div class="col-12 col-lg-8">
                <article class="glass-card blog-detail-card">
                    <div class="blog-detail-header">
                        <img src="@heroImage" alt="@Model.ArticleTitle" class="blog-detail-cover" />
                        <div class="blog-detail-summary">
                            <h1 class="fw-bold">@Model.ArticleTitle</h1>
                            <div class="blog-meta">
                                <span>✍️ @Model.Writer</span>
                            </div>
                        </div>
                    </div>
                    <div class="glass-helper mb-3 blog-detail-excerpt">@Html.Raw(Model.ShortDescription)</div>
                    <div class="blog-detail-content">
                        @Html.Raw(Model.ArticleDescription)
                    </div>
                </article>
            </div>
            <div class="col-12 col-lg-4">
                <aside class="glass-card blog-detail-search blog-search-card">
                    <h5 class="fw-semibold mb-3">جستجوی سایر مقالات</h5>
                    @await Html.PartialAsync("_SearchForm", new BlogSearchFormViewModel
                    {
                        FieldIdSuffix = "Detail",
                        SubmitLabel = "جستجوی مقالات",
                        UseCompactLayout = true
                    })
                </aside>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script src="~/js/persian-datepicker.js" asp-append-version="true"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (window.PersianDatePicker && typeof window.PersianDatePicker.init === 'function') {
                window.PersianDatePicker.init();
            }

            const themeHref = 'https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css';
            if (!document.querySelector(`link[href="${themeHref}"]`)) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = themeHref;
                document.head.appendChild(link);
            }

            const copyText = async (text) => {
                if (!text) {
                    return false;
                }

                if (navigator.clipboard && window.isSecureContext) {
                    try {
                        await navigator.clipboard.writeText(text);
                        return true;
                    } catch (error) {
                        // fallback to legacy approach
                    }
                }

                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.setAttribute('readonly', '');
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';

                    const container = document.body || document.documentElement;
                    container.appendChild(textArea);
                    textArea.focus();
                    textArea.select();

                    const successful = document.execCommand('copy');
                    textArea.remove();
                    return successful;
                } catch (error) {
                    return false;
                }
            };

            document.querySelectorAll('.blog-detail-content pre code').forEach(function (block) {
                hljs.highlightElement(block);

                const pre = block.parentElement;
                if (!pre) {
                    return;
                }

                pre.classList.add('code-toolbar');

                if (!pre.querySelector('.code-toolbar-header')) {
                    const header = document.createElement('div');
                    header.className = 'code-toolbar-header';

                    const languageClass = Array.from(block.classList).find(cls => cls.startsWith('language-'));
                    const language = languageClass ? languageClass.replace('language-', '').toUpperCase() : 'CODE';

                    const badge = document.createElement('span');
                    badge.className = 'code-language-badge';
                    badge.textContent = language;

                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'copy-code-button';
                    button.textContent = 'کپی';

                    button.addEventListener('click', async function () {
                        const text = block.innerText;
                        const copied = await copyText(text);
                        if (copied) {
                            const original = button.textContent;
                            button.textContent = 'کپی شد!';
                            setTimeout(function () {
                                button.textContent = original;
                            }, 2000);
                            return;
                        }

                        button.textContent = 'خطا';
                        setTimeout(function () {
                            button.textContent = 'کپی';
                        }, 2000);
                    });

                    header.appendChild(badge);
                    header.appendChild(button);
                    pre.appendChild(header);
                }
            });
        });
    </script>
}
