@model ChamedoonWebUI.Models.BlogIndexViewModel
@using System
@using System.Linq
@using System.Globalization
@{ 
    ViewData["Title"] = "وبلاگ";
    var writers = Model.Articles.Select(a => a.Writer).Distinct().ToList();
    var dateFromValue = Model.DateFrom?.ToString("yyyy-MM-dd") ?? string.Empty;
    var dateToValue = Model.DateTo?.ToString("yyyy-MM-dd") ?? string.Empty;
    var culture = CultureInfo.GetCultureInfo("fa-IR");

    Func<string?, string> resolveArticleImage = imageName =>
    {
        if (string.IsNullOrWhiteSpace(imageName))
        {
            return Url.Content("~/images/blog/01.jpg");
        }

        var trimmed = imageName.Trim();

        if (Uri.TryCreate(trimmed, UriKind.Absolute, out _))
        {
            return trimmed;
        }

        trimmed = trimmed.TrimStart('~').TrimStart('/');

        if (trimmed.Contains("/"))
        {
            return Url.Content($"~/{trimmed}");
        }

        return Url.Content($"~/images/blog/{trimmed}");
    };
}

<section class="glass-section">
    <div class="container">
        <div class="blog-hero">
            <h1 class="fw-bold">کاوش در تجربه‌های مهاجرت و زندگی در کشورهای مختلف.</h1>
            <p class="glass-helper mb-0">مقالات چمدون توسط تیم تحقیق و کاربران باتجربه نوشته شده‌اند تا مسیر مهاجرت را برایت شفاف کنند.</p>
        </div>

        <div class="glass-card blog-search-card mb-4">
            <h5 class="fw-semibold mb-3">جستجوی پیشرفته</h5>
            <form method="get" asp-action="Index" asp-controller="Blog" class="row g-3 align-items-end">
                <div class="col-lg-4 col-md-6">
                    <label for="search" class="form-label">کلمه کلیدی</label>
                    <input type="text" id="search" name="search" class="form-control" placeholder="عنوان یا متن مقاله..." value="@Model.Search" />
                </div>
                <div class="col-lg-3 col-md-6">
                    <label for="writer" class="form-label">نویسنده</label>
                    <select id="writer" name="writer" class="form-select">
                        <option value="">همه</option>
                        @foreach (var w in writers)
                        {
                            if (Model.Writer == w)
                            {
                                <option value="@w" selected>@w</option>
                            }
                            else
                            {
                                <option value="@w">@w</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-lg-2 col-md-6">
                    <label for="dateFromDisplay" class="form-label">از تاریخ</label>
                    <div class="jalali-input-wrapper">
                        <button type="button"
                                class="jalali-input-trigger"
                                data-target="#dateFromDisplay"
                                aria-label="باز کردن تقویم">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1.75A2.25 2.25 0 0 1 22 6.25v13.5A2.25 2.25 0 0 1 19.75 22H4.25A2.25 2.25 0 0 1 2 19.75V6.25A2.25 2.25 0 0 1 4.25 4H6V3a1 1 0 0 1 1-1Zm13.25 6.5H3.75v11.25c0 .414.336.75.75.75h15c.414 0 .75-.336.75-.75Z"></path>
                                <path d="M7.75 11h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1 0-1.5Zm6 0h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 1 1 0-1.5Zm-6 4h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 1 1 0-1.5Zm6 0h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 1 1 0-1.5Z"></path>
                            </svg>
                        </button>
                        <input type="text"
                               id="dateFromDisplay"
                               class="form-control jalali-date-input"
                               placeholder="انتخاب تاریخ شمسی"
                               autocomplete="off"
                               inputmode="numeric"
                               dir="ltr"
                               data-alt-field="#dateFromValue"
                               data-initial-value="@dateFromValue" />
                        <button type="button"
                                class="jalali-clear-button"
                                data-target="#dateFromDisplay"
                                data-alt="#dateFromValue"
                                aria-label="حذف تاریخ">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                    <input type="hidden" id="dateFromValue" name="dateFrom" value="@dateFromValue" />
                </div>
                <div class="col-lg-2 col-md-6">
                    <label for="dateToDisplay" class="form-label">تا تاریخ</label>
                    <div class="jalali-input-wrapper">
                        <button type="button"
                                class="jalali-input-trigger"
                                data-target="#dateToDisplay"
                                aria-label="باز کردن تقویم">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1.75A2.25 2.25 0 0 1 22 6.25v13.5A2.25 2.25 0 0 1 19.75 22H4.25A2.25 2.25 0 0 1 2 19.75V6.25A2.25 2.25 0 0 1 4.25 4H6V3a1 1 0 0 1 1-1Zm13.25 6.5H3.75v11.25c0 .414.336.75.75.75h15c.414 0 .75-.336.75-.75Z"></path>
                                <path d="M7.75 11h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1 0-1.5Zm6 0h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 1 1 0-1.5Zm-6 4h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 1 1 0-1.5Zm6 0h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 1 1 0-1.5Z"></path>
                            </svg>
                        </button>
                        <input type="text"
                               id="dateToDisplay"
                               class="form-control jalali-date-input"
                               placeholder="انتخاب تاریخ شمسی"
                               autocomplete="off"
                               inputmode="numeric"
                               dir="ltr"
                               data-alt-field="#dateToValue"
                               data-initial-value="@dateToValue" />
                        <button type="button"
                                class="jalali-clear-button"
                                data-target="#dateToDisplay"
                                data-alt="#dateToValue"
                                aria-label="حذف تاریخ">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                    <input type="hidden" id="dateToValue" name="dateTo" value="@dateToValue" />
                </div>
                <div class="col-lg-1 col-12 d-grid">
                    <button type="submit" class="btn-glass-primary">جستجو</button>
                </div>
            </form>
        </div>

        @if (!Model.Articles.Any())
        {
            <div class="glass-card blog-empty-state">
                <h4 class="fw-semibold mb-2">مقاله‌ای مطابق فیلترها یافت نشد</h4>
                <p class="glass-helper mb-0">فیلترها را تغییر بده یا کلمه کلیدی دیگری وارد کن تا نتایج بیشتری نمایش داده شود.</p>
            </div>
        }
        else
        {
            <div class="blog-grid">
                @foreach (var item in Model.Articles)
                {
                    var imageSource = resolveArticleImage(item.ArticleImageName);
                    <article class="glass-card blog-card">
                        <img src="@imageSource" alt="@item.ArticleTitle" />
                        <div class="blog-body">
                            <a asp-controller="Blog" asp-action="Detail" asp-route-id="@item.Id" class="stretched-link"></a>
                            <h5 class="fw-semibold">@item.ArticleTitle</h5>
                            <p class="glass-helper blog-summary mb-0">@item.ShortDescription</p>
                            <div class="blog-meta">
                                <div class="blog-meta-info">
                                    <span class="blog-meta-author">✍️ @item.Writer</span>
                                    <span class="blog-meta-divider" aria-hidden="true">•</span>
                                    <span class="blog-meta-views" aria-label="تعداد بازدید">
                                        <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                            <path d="M12 5.25c5.52 0 9.41 4.35 10.61 6.01a1.25 1.25 0 0 1 0 1.48C21.41 14.39 17.52 18.75 12 18.75S2.59 14.39 1.39 12.74a1.25 1.25 0 0 1 0-1.48C2.59 9.6 6.48 5.25 12 5.25Zm0 2c-4.35 0-7.71 3.29-8.91 4.75 1.2 1.46 4.56 4.75 8.91 4.75s7.71-3.29 8.91-4.75c-1.2-1.46-4.56-4.75-8.91-4.75Zm0 1.75a3.25 3.25 0 1 1 0 6.5 3.25 3.25 0 0 1 0-6.5Zm0 2a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Z"></path>
                                        </svg>
                                        @item.VisitCount.ToString("N0", culture)
                                        <span class="blog-meta-views-label">بازدید</span>
                                    </span>
                                </div>
                                <a asp-controller="Blog" asp-action="Detail" asp-route-id="@item.Id" class="blog-link">ادامه مطلب</a>
                            </div>
                        </div>
                    </article>
                }
            </div>
        }

        @if (Model.TotalPages > 1)
        {
            <nav aria-label="صفحه‌های وبلاگ" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(Model.CurrentPage <= 1 ? "disabled" : string.Empty)">
                        <a class="page-link" asp-action="Index" asp-route-page="@(Model.CurrentPage - 1)" asp-route-search="@Model.Search" asp-route-writer="@Model.Writer" asp-route-dateFrom="@(Model.DateFrom?.ToString("yyyy-MM-dd"))" asp-route-dateTo="@(Model.DateTo?.ToString("yyyy-MM-dd"))">قبلی</a>
                    </li>
                    @for (var i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : string.Empty)">
                            <a class="page-link" asp-action="Index" asp-route-page="@i" asp-route-search="@Model.Search" asp-route-writer="@Model.Writer" asp-route-dateFrom="@(Model.DateFrom?.ToString("yyyy-MM-dd"))" asp-route-dateTo="@(Model.DateTo?.ToString("yyyy-MM-dd"))">@i</a>
                        </li>
                    }
                    <li class="page-item @(Model.CurrentPage >= Model.TotalPages ? "disabled" : string.Empty)">
                        <a class="page-link" asp-action="Index" asp-route-page="@(Model.CurrentPage + 1)" asp-route-search="@Model.Search" asp-route-writer="@Model.Writer" asp-route-dateFrom="@(Model.DateFrom?.ToString("yyyy-MM-dd"))" asp-route-dateTo="@(Model.DateTo?.ToString("yyyy-MM-dd"))">بعدی</a>
                    </li>
                </ul>
            </nav>
        }
    </div>
</section>

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" />
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <script src="~/js/blog.js" asp-append-version="true"></script>
}
