@model ChamedoonWebUI.Models.BlogIndexViewModel
@using System.Linq
@using System.Globalization
@{ 
    ViewData["Title"] = "وبلاگ";
    var writers = Model.Articles.Select(a => a.Writer).Distinct().ToList();
    Func<DateTime, string> toPersianDate = date =>
    {
        var calendar = new PersianCalendar();
        var year = calendar.GetYear(date);
        var month = calendar.GetMonth(date);
        var day = calendar.GetDayOfMonth(date);
        return $"{year:0000}/{month:00}/{day:00}";
    };
    var dateFromValue = Model.DateFrom?.ToString("yyyy-MM-dd");
    var dateToValue = Model.DateTo?.ToString("yyyy-MM-dd");
    var dateFromDisplay = Model.DateFrom.HasValue ? toPersianDate(Model.DateFrom.Value) : string.Empty;
    var dateToDisplay = Model.DateTo.HasValue ? toPersianDate(Model.DateTo.Value) : string.Empty;
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@babakhani/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" />
}

<section class="glass-section">
    <div class="container">
        <div class="blog-hero">
            <h1 class="fw-bold">کاوش در تجربه‌های مهاجرت و زندگی در کشورهای مختلف.</h1>
            <p class="glass-helper mb-0">مقالات چمدون توسط تیم تحقیق و کاربران باتجربه نوشته شده‌اند تا مسیر مهاجرت را برایت شفاف کنند.</p>
        </div>

        <div class="glass-card blog-search-card mb-4">
            <form method="get" asp-action="Index" asp-controller="Blog" class="row g-3 align-items-end">
                <div class="col-lg-4 col-md-6">
                    <label for="search" class="form-label">عنوان مقاله</label>
                    <input type="text" id="search" name="search" class="form-control" placeholder="جستجو در عنوان مقاله" value="@Model.Search" />
                </div>
                <div class="col-lg-3 col-md-6">
                    <label for="writer" class="form-label">نویسنده</label>
                    <select id="writer" name="writer" class="form-select">
                        <option value="">همه</option>
                        @foreach (var w in writers)
                        {
                            if (Model.Writer == w)
                            {
                                <option value="@w" selected>@w</option>
                            }
                            else
                            {
                                <option value="@w">@w</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-lg-2 col-md-6">
                    <label for="dateFromPicker" class="form-label">از تاریخ</label>
                    <div class="persian-datepicker-field">
                        <input type="text" id="dateFromPicker" class="form-control persian-datepicker-input" placeholder="انتخاب تاریخ شمسی" value="@dateFromDisplay" autocomplete="off" />
                        <input type="hidden" id="dateFrom" name="dateFrom" value="@dateFromValue" />
                    </div>
                </div>
                <div class="col-lg-2 col-md-6">
                    <label for="dateToPicker" class="form-label">تا تاریخ</label>
                    <div class="persian-datepicker-field">
                        <input type="text" id="dateToPicker" class="form-control persian-datepicker-input" placeholder="انتخاب تاریخ شمسی" value="@dateToDisplay" autocomplete="off" />
                        <input type="hidden" id="dateTo" name="dateTo" value="@dateToValue" />
                    </div>
                </div>
                <div class="col-lg-1 col-12 d-grid">
                    <button type="submit" class="btn-glass-primary">جستجو</button>
                </div>
            </form>
        </div>

        @if (!Model.Articles.Any())
        {
            <div class="glass-card blog-empty-state">
                <h4 class="fw-semibold mb-2">مقاله‌ای مطابق فیلترها یافت نشد</h4>
                <p class="glass-helper mb-0">فیلترها را تغییر بده یا کلمه کلیدی دیگری وارد کن تا نتایج بیشتری نمایش داده شود.</p>
            </div>
        }
        else
        {
            <div class="blog-grid">
                @foreach (var item in Model.Articles)
                {
                    var imageName = !string.IsNullOrEmpty(item.ArticleImageName)
                        ? item.ArticleImageName
                        : "01.jpg";
                    var visitCountText = item.VisitCount.ToString("N0", CultureInfo.CreateSpecificCulture("fa-IR"));
                    var shareUrl = Url.Action("Detail", "Blog", new { id = item.Id }, Context.Request.Scheme);
                    <article class="glass-card blog-card">
                        <img src="~/images/blog/@imageName" alt="@item.ArticleTitle" />
                        <div class="blog-body">
                            <a asp-controller="Blog" asp-action="Detail" asp-route-id="@item.Id" class="stretched-link"></a>
                            <h5 class="fw-semibold">@item.ArticleTitle</h5>
                            <p class="glass-helper mb-0 blog-card-description">@item.ShortDescription</p>
                            <a asp-controller="Blog" asp-action="Detail" asp-route-id="@item.Id" class="blog-link blog-read-more">ادامه مطلب</a>
                            <div class="blog-meta">
                                <span class="blog-meta-item" aria-label="@visitCountText بازدید">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6S2 12 2 12Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></circle>
                                    </svg>
                                    <span>@visitCountText</span>
                                </span>
                                <button type="button" class="blog-share-button" data-share-url="@shareUrl" data-share-title="@item.ArticleTitle" aria-label="اشتراک‌گذاری مطلب @item.ArticleTitle" title="اشتراک‌گذاری">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                                        <path d="M8 7.5 12 4l4 3.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                                        <path d="M12 4v11" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </article>
                }
            </div>
        }

        @if (Model.TotalPages > 1)
        {
            <nav aria-label="صفحه‌های وبلاگ" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(Model.CurrentPage <= 1 ? "disabled" : string.Empty)">
                        <a class="page-link" asp-action="Index" asp-route-page="@(Model.CurrentPage - 1)" asp-route-search="@Model.Search" asp-route-writer="@Model.Writer" asp-route-dateFrom="@(Model.DateFrom?.ToString("yyyy-MM-dd"))" asp-route-dateTo="@(Model.DateTo?.ToString("yyyy-MM-dd"))">قبلی</a>
                    </li>
                    @for (var i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : string.Empty)">
                            <a class="page-link" asp-action="Index" asp-route-page="@i" asp-route-search="@Model.Search" asp-route-writer="@Model.Writer" asp-route-dateFrom="@(Model.DateFrom?.ToString("yyyy-MM-dd"))" asp-route-dateTo="@(Model.DateTo?.ToString("yyyy-MM-dd"))">@i</a>
                        </li>
                    }
                    <li class="page-item @(Model.CurrentPage >= Model.TotalPages ? "disabled" : string.Empty)">
                        <a class="page-link" asp-action="Index" asp-route-page="@(Model.CurrentPage + 1)" asp-route-search="@Model.Search" asp-route-writer="@Model.Writer" asp-route-dateFrom="@(Model.DateFrom?.ToString("yyyy-MM-dd"))" asp-route-dateTo="@(Model.DateTo?.ToString("yyyy-MM-dd"))">بعدی</a>
                    </li>
                </ul>
            </nav>
        }
    </div>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babakhani/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const setupDatepicker = (inputSelector, hiddenSelector, initialValue) => {
                const $input = window.jQuery(inputSelector);
                if (!$input.length) {
                    return;
                }

                $input.persianDatepicker({
                    format: 'YYYY/MM/DD',
                    altField: hiddenSelector,
                    altFormat: 'YYYY-MM-DD',
                    autoClose: true,
                    initialValue: false,
                    calendar: {
                        type: 'persian',
                        persian: {
                            leapYearMode: 'astronomical'
                        }
                    },
                    navigator: {
                        text: {
                            btnNextText: 'بعدی',
                            btnPrevText: 'قبلی'
                        }
                    },
                    toolbox: {
                        calendarSwitch: {
                            enabled: false
                        }
                    }
                });

                const instance = $input.data('datepicker');

                if (initialValue && instance) {
                    try {
                        const persian = new persianDate(new Date(initialValue));
                        instance.setDate(persian);
                    } catch (error) {
                        // اگر مقدار اولیه نامعتبر باشد، آن را نادیده می‌گیریم
                    }
                }

                $input.on('input', function () {
                    if (!this.value) {
                        window.jQuery(hiddenSelector).val('');
                    }
                });
            };

            const initialDateFrom = '@(dateFromValue ?? string.Empty)';
            const initialDateTo = '@(dateToValue ?? string.Empty)';

            setupDatepicker('#dateFromPicker', '#dateFrom', initialDateFrom);
            setupDatepicker('#dateToPicker', '#dateTo', initialDateTo);

            const notifyShare = (button, message) => {
                button.classList.add('is-shared');
                button.setAttribute('data-share-feedback', message);
                window.setTimeout(() => {
                    button.classList.remove('is-shared');
                    button.removeAttribute('data-share-feedback');
                }, 2000);
            };

            document.querySelectorAll('.blog-share-button').forEach((button) => {
                button.addEventListener('click', async () => {
                    const url = button.getAttribute('data-share-url');
                    const title = button.getAttribute('data-share-title');
                    if (!url) {
                        return;
                    }

                    if (navigator.share) {
                        try {
                            await navigator.share({ title, url });
                            notifyShare(button, 'ارسال شد');
                            return;
                        } catch (error) {
                            // کاربر اشتراک‌گذاری را لغو کرده است یا پشتیبانی نمی‌شود
                        }
                    }

                    if (navigator.clipboard && window.isSecureContext) {
                        try {
                            await navigator.clipboard.writeText(url);
                            notifyShare(button, 'کپی شد');
                            return;
                        } catch (error) {
                            // در صورت عدم موفقیت از حالت پیش‌فرض استفاده می‌کنیم
                        }
                    }

                    notifyShare(button, 'لینک: ' + url);
                });
            });
        });
    </script>
}
