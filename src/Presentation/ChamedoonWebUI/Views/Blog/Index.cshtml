@model ChamedoonWebUI.Models.BlogIndexViewModel
@using System
@using System.Linq
@using System.Globalization
@using ChamedoonWebUI.Models
@{ 
    ViewData["Title"] = "وبلاگ";
    var writers = Model.Articles.Select(a => a.Writer).Distinct().ToList();
    var culture = CultureInfo.GetCultureInfo("fa-IR");
    var hasFilters = !string.IsNullOrWhiteSpace(Model.Search) ||
                     !string.IsNullOrWhiteSpace(Model.Writer) ||
                     Model.DateFrom.HasValue ||
                     Model.DateTo.HasValue;
    var searchModel = new BlogSearchFormModel
    {
        FormIdPrefix = "blogIndex",
        Action = "Index",
        Controller = "Blog",
        SubmitLabel = "جستجو",
        SubmitButtonClass = "btn-glass-primary",
        Search = Model.Search,
        Writer = Model.Writer,
        WriterOptions = writers,
        DateFrom = Model.DateFrom,
        DateTo = Model.DateTo,
        ShowReset = hasFilters
    };

    Func<string?, string> resolveArticleImage = imageName =>
    {
        if (string.IsNullOrWhiteSpace(imageName))
        {
            return Url.Content("~/images/blog/01.jpg");
        }

        var trimmed = imageName.Trim();

        if (Uri.TryCreate(trimmed, UriKind.Absolute, out _))
        {
            return trimmed;
        }

        trimmed = trimmed.TrimStart('~').TrimStart('/');

        if (trimmed.Contains("/"))
        {
            return Url.Content($"~/{trimmed}");
        }

        return Url.Content($"~/images/blog/{trimmed}");
    };
}

<section class="glass-section">
    <div class="container">
        <div class="blog-hero">
            <h1 class="fw-bold">کاوش در تجربه‌های مهاجرت و زندگی در کشورهای مختلف.</h1>
            <p class="glass-helper mb-0">مقالات چمدون توسط تیم تحقیق و کاربران باتجربه نوشته شده‌اند تا مسیر مهاجرت را برایت شفاف کنند.</p>
        </div>

        <div class="glass-card blog-search-card mb-4">
            <h5 class="fw-semibold mb-3">جستجوی پیشرفته</h5>
            <partial name="Partials/_SearchForm" model="searchModel" />
        </div>

        @if (!Model.Articles.Any())
        {
            <div class="glass-card blog-empty-state">
                <h4 class="fw-semibold mb-2">مقاله‌ای مطابق فیلترها یافت نشد</h4>
                <p class="glass-helper mb-0">فیلترها را تغییر بده یا کلمه کلیدی دیگری وارد کن تا نتایج بیشتری نمایش داده شود.</p>
            </div>
        }
        else
        {
            <div class="blog-grid">
                @foreach (var item in Model.Articles)
                {
                    var imageSource = resolveArticleImage(item.ArticleImageName);
                    var detailUrl = Url.Action("Detail", "Blog", new { id = item.Id }) ?? "#";
                    var shareUrl = Url.Action("Detail", "Blog", new { id = item.Id }, Context.Request.Scheme) ?? detailUrl;
                    var metaModel = new BlogArticleMetaModel
                    {
                        Writer = item.Writer ?? string.Empty,
                        VisitCountText = item.VisitCount.ToString("N0", culture),
                        VisitLabel = "تعداد بازدید",
                        ShareUrl = shareUrl,
                        ShareTitle = item.ArticleTitle,
                        ShareText = item.ShortDescription
                    };
                    var cardModel = new BlogArticleCardModel
                    {
                        Title = item.ArticleTitle,
                        ShortDescription = item.ShortDescription,
                        ImageUrl = imageSource,
                        DetailUrl = detailUrl,
                        Meta = metaModel
                    };
                    <partial name="Partials/_ArticleCard" model="cardModel" />
                }
            </div>
        }

        @if (Model.TotalPages > 1)
        {
            <nav aria-label="صفحه‌های وبلاگ" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(Model.CurrentPage <= 1 ? "disabled" : string.Empty)">
                        <a class="page-link" asp-action="Index" asp-route-page="@(Model.CurrentPage - 1)" asp-route-search="@Model.Search" asp-route-writer="@Model.Writer" asp-route-dateFrom="@(Model.DateFrom?.ToString("yyyy-MM-dd"))" asp-route-dateTo="@(Model.DateTo?.ToString("yyyy-MM-dd"))">قبلی</a>
                    </li>
                    @for (var i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : string.Empty)">
                            <a class="page-link" asp-action="Index" asp-route-page="@i" asp-route-search="@Model.Search" asp-route-writer="@Model.Writer" asp-route-dateFrom="@(Model.DateFrom?.ToString("yyyy-MM-dd"))" asp-route-dateTo="@(Model.DateTo?.ToString("yyyy-MM-dd"))">@i</a>
                        </li>
                    }
                    <li class="page-item @(Model.CurrentPage >= Model.TotalPages ? "disabled" : string.Empty)">
                        <a class="page-link" asp-action="Index" asp-route-page="@(Model.CurrentPage + 1)" asp-route-search="@Model.Search" asp-route-writer="@Model.Writer" asp-route-dateFrom="@(Model.DateFrom?.ToString("yyyy-MM-dd"))" asp-route-dateTo="@(Model.DateTo?.ToString("yyyy-MM-dd"))">بعدی</a>
                    </li>
                </ul>
            </nav>
        }
    </div>
</section>

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.css" integrity="sha384-G7oizPQ+fPyA9xx0ScE6rKsn7BNQYXT33yHuEq+nCgtgK6IqKsZN1OtNLkwKo6k6" crossorigin="anonymous" />
    <link rel="stylesheet" href="~/css/blog/layout.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/blog/card.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/blog/meta.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/blog/search.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/components/datepicker.css" asp-append-version="true" />
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js" integrity="sha384-Z3cr0UyAeMZZpMzQy51VCZHKktHG5bBg8TsFSxKxBd9Mu+m6nH2MA0/QRPq1aEQJ" crossorigin="anonymous"></script>
    <script src="~/js/components/jalali-datepicker.js" asp-append-version="true"></script>
    <script src="~/js/blog/share.js" asp-append-version="true"></script>
}
