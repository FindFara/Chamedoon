@model UsersIndexViewModel
@using System
@using System.Globalization
@using System.Linq
@{
    ViewData["Title"] = "مدیریت کاربران";
    string FormatPersianDate(DateTime? date)
    {
        if (!date.HasValue)
        {
            return string.Empty;
        }

        var calendar = new PersianCalendar();
        var year = calendar.GetYear(date.Value);
        var month = calendar.GetMonth(date.Value);
        var day = calendar.GetDayOfMonth(date.Value);
        return $"{year:0000}/{month:00}/{day:00}";
    }

    var fromDateHidden = Model.FromDate?.ToString("yyyy-MM-dd");
    var toDateHidden = Model.ToDate?.ToString("yyyy-MM-dd");
    var fromDateDisplay = FormatPersianDate(Model.FromDate);
    var toDateDisplay = FormatPersianDate(Model.ToDate);
}

<div class="container-fluid py-4 admin-section users-section">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">کاربران</h1>
        <a asp-action="Create" class="btn btn-primary">افزودن کاربر جدید</a>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-4 col-lg-3">
                    <label for="fromDatePicker" class="form-label">از تاریخ</label>
                    <div class="persian-datepicker-field">
                        <input id="fromDatePicker" class="form-control persian-datepicker-input" placeholder="انتخاب تاریخ شمسی" value="@fromDateDisplay" autocomplete="off" data-persian-picker data-alt-field="#fromDate" />
                        <input type="hidden" id="fromDate" name="fromDate" value="@fromDateHidden" />
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <label for="toDatePicker" class="form-label">تا تاریخ</label>
                    <div class="persian-datepicker-field">
                        <input id="toDatePicker" class="form-control persian-datepicker-input" placeholder="انتخاب تاریخ شمسی" value="@toDateDisplay" autocomplete="off" data-persian-picker data-alt-field="#toDate" />
                        <input type="hidden" id="toDate" name="toDate" value="@toDateHidden" />
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <label for="search" class="form-label">جستجو</label>
                    <input id="search" name="search" value="@Model.SearchTerm" class="form-control" placeholder="نام، نام کاربری، ایمیل یا شماره همراه" />
                </div>
                <div class="col-md-6 col-lg-3">
                    <label for="roleId" class="form-label">نقش</label>
                    <select id="roleId" name="roleId" class="form-select">
                        <option value="">همه نقش‌ها</option>
                        @foreach (var role in Model.Roles)
                        {
                            var isSelected = Model.SelectedRoleId == role.Id;
                            if (isSelected)
                            {
                                <option value="@role.Id" selected>@role.Name</option>
                            }
                            else
                            {
                                <option value="@role.Id">@role.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-6 col-lg-3">
                    <label for="subscriptionPlanId" class="form-label">اشتراک</label>
                    <select id="subscriptionPlanId" name="subscriptionPlanId" class="form-select">
                        <option value="">همه اشتراک‌ها</option>
                        @foreach (var plan in Model.Plans)
                        {
                            var isSelected = string.Equals(Model.SelectedSubscriptionPlanId, plan.Id, StringComparison.OrdinalIgnoreCase);
                            if (isSelected)
                            {
                                <option value="@plan.Id" selected>@plan.Title</option>
                            }
                            else
                            {
                                <option value="@plan.Id">@plan.Title</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-6 col-lg-2">
                    <label for="pageSize" class="form-label">تعداد نمایش</label>
                    <select id="pageSize" name="pageSize" class="form-select">
                        @foreach (var size in Model.PageSizeOptions)
                        {
                            if (size == Model.PageSize)
                            {
                                <option value="@size" selected>@size</option>
                            }
                            else
                            {
                                <option value="@size">@size</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-12 d-flex justify-content-end align-items-end">
                    <button type="submit" class="btn btn-outline-primary btn-sm px-4">جستجو</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            @if (!Model.Users.Any())
            {
                <div class="p-4 text-center text-muted">کاربری برای نمایش وجود ندارد.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>نام</th>
                            <th>ایمیل</th>
                            <th>شماره همراه</th>
                            <th>نقش</th>
                            <th>اشتراک</th>
                            <th>وضعیت</th>
                            <th>تاریخ ایجاد</th>
                            <th class="text-end">عملیات</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var user in Model.Users)
                        {
                            <tr>
                                <td>@(string.IsNullOrWhiteSpace(user.FullName) ? user.UserName : user.FullName)</td>
                                <td>@user.Email</td>
                                <td>@(string.IsNullOrWhiteSpace(user.PhoneNumber) ? "-" : user.PhoneNumber)</td>
                                <td>@(string.IsNullOrWhiteSpace(user.RoleName) ? "-" : user.RoleName)</td>
                                <td>
                                    @if (!string.IsNullOrWhiteSpace(user.SubscriptionPlanTitle))
                                    {
                                        <div class="d-flex flex-column">
                                            <strong>@user.SubscriptionPlanTitle</strong>
                                            @if (user.SubscriptionEndDateUtc is not null)
                                            {
                                                <small class="text-muted">تا @user.SubscriptionEndDateUtc?.ToString("yyyy/MM/dd")</small>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (user.IsActive)
                                    {
                                        <span class="badge bg-success">فعال</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">غیرفعال</span>
                                    }
                                </td>
                                <td>@user.CreatedAt.ToString("yyyy/MM/dd HH:mm")</td>
                                <td class="text-end">
                                    <div class="d-flex justify-content-end gap-2">
                                        <a asp-action="Edit" asp-route-id="@user.Id" class="btn btn-sm btn-outline-primary">ویرایش</a>
                                        <form asp-action="Delete" asp-route-id="@user.Id" method="post" onsubmit="return confirm('آیا از حذف این کاربر مطمئن هستید؟');" class="m-0">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-outline-danger">حذف</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
                @if (Model.TotalPages > 1)
                {
                    var startPage = Math.Max(1, Model.CurrentPage - 2);
                    var endPage = Math.Min(Model.TotalPages, startPage + 4);
                    startPage = Math.Max(1, endPage - 4);

                    <nav aria-label="صفحات کاربران" class="p-3 admin-pagination">
                        <ul class="pagination justify-content-end mb-0">
                            <li class="page-item @(Model.CurrentPage <= 1 ? "disabled" : string.Empty)">
                                <a class="page-link"
                                   asp-action="Index"
                                   asp-route-page="@(Model.CurrentPage - 1)"
                                   asp-route-pageSize="@Model.PageSize"
                                   asp-route-search="@Model.SearchTerm"
                                   asp-route-roleId="@Model.SelectedRoleId"
                                   asp-route-subscriptionPlanId="@Model.SelectedSubscriptionPlanId"
                                   asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                                   asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")">قبلی</a>
                            </li>
                            @for (var i = startPage; i <= endPage; i++)
                            {
                                <li class="page-item @(i == Model.CurrentPage ? "active" : string.Empty)">
                                    <a class="page-link"
                                       asp-action="Index"
                                       asp-route-page="@i"
                                       asp-route-pageSize="@Model.PageSize"
                                       asp-route-search="@Model.SearchTerm"
                                       asp-route-roleId="@Model.SelectedRoleId"
                                       asp-route-subscriptionPlanId="@Model.SelectedSubscriptionPlanId"
                                       asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                                       asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")">@i</a>
                                </li>
                            }
                            <li class="page-item @(Model.CurrentPage >= Model.TotalPages ? "disabled" : string.Empty)">
                                <a class="page-link"
                                   asp-action="Index"
                                   asp-route-page="@(Model.CurrentPage + 1)"
                                   asp-route-pageSize="@Model.PageSize"
                                   asp-route-search="@Model.SearchTerm"
                                   asp-route-roleId="@Model.SelectedRoleId"
                                   asp-route-subscriptionPlanId="@Model.SelectedSubscriptionPlanId"
                                   asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                                   asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")">بعدی</a>
                            </li>
                        </ul>
                    </nav>
                }
            }
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/persian-datepicker.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/persian-datepicker.js" asp-append-version="true"></script>
    <script>
        (function () {
            if (window.PersianDatePicker && typeof window.PersianDatePicker.init === 'function') {
                window.PersianDatePicker.init();
            }
        })();
    </script>
}
