@model PaymentReportIndexViewModel
@using Chamedoon.Domin.Enums
@{
    ViewData["Title"] = "گزارش پرداخت‌ها";
    var statuses = Enum.GetValues(typeof(PaymentStatus)).Cast<PaymentStatus>().ToList();
    var startPage = Math.Max(1, Model.CurrentPage - 2);
    var endPage = Math.Min(Model.TotalPages, startPage + 4);
    startPage = Math.Max(1, endPage - 4);

    var fromDateHidden = Model.FromDate?.ToString("yyyy-MM-dd");
    var toDateHidden = Model.ToDate?.ToString("yyyy-MM-dd");
    var fromDateDisplay = Model.FromDate.ConvertMiladiToShamsi();
    var toDateDisplay = Model.ToDate.ConvertMiladiToShamsi();
}

<div class="container-fluid py-4 admin-section payments-section">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">گزارش پرداخت‌ها</h1>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-4 col-lg-3">
                    <label for="fromDatePicker" class="form-label">از تاریخ</label>
                    <div class="persian-datepicker-field">
                        <input id="fromDatePicker" class="form-control persian-datepicker-input" placeholder="انتخاب تاریخ شمسی" value="@fromDateDisplay" autocomplete="off" data-persian-picker data-alt-field="#fromDate" />
                        <input type="hidden" id="fromDate" name="fromDate" value="@fromDateHidden" />
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <label for="toDatePicker" class="form-label">تا تاریخ</label>
                    <div class="persian-datepicker-field">
                        <input id="toDatePicker" class="form-control persian-datepicker-input" placeholder="انتخاب تاریخ شمسی" value="@toDateDisplay" autocomplete="off" data-persian-picker data-alt-field="#toDate" />
                        <input type="hidden" id="toDate" name="toDate" value="@toDateHidden" />
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <label for="userName" class="form-label">نام کاربر</label>
                    <input id="userName" name="userName" value="@Model.UserName" class="form-control" placeholder="نام یا نام کاربری" />
                </div>
                <div class="col-md-6 col-lg-3">
                    <label for="search" class="form-label">جستجو</label>
                    <input id="search" name="search" value="@Model.SearchTerm" class="form-control" placeholder="کد پیگیری، توضیحات یا پلن" />
                </div>
                <div class="col-md-6 col-lg-3">
                    <label for="status" class="form-label">وضعیت</label>
                    <select id="status" name="status" class="form-select payment-status-select">
                        <option value="">همه وضعیت‌ها</option>
                        @foreach (var status in statuses)
                        {
                            var isSelected = Model.SelectedStatus == status;
                            var statusLabel = status switch
                            {
                                PaymentStatus.Paid => "موفق",
                                PaymentStatus.Pending => "در انتظار",
                                PaymentStatus.Redirected => "در انتظار",
                                PaymentStatus.Failed => "ناموفق",
                                PaymentStatus.Cancelled => "لغو شده",
                                _ => status.ToString()
                            };
                            <option value="@((int)status)" selected="@(isSelected ? "selected" : null)">@statusLabel</option>
                        }
                    </select>
                </div>
                <div class="col-12 d-flex justify-content-end align-items-end">
                    <button type="submit" class="btn btn-outline-primary btn-sm px-4">جستوجو</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            @if (!Model.Payments.Any())
            {
                <div class="p-4 text-center text-muted">پرداختی برای نمایش وجود ندارد.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>کد تراکنش</th>
                            <th>کاربر</th>
                            <th>پلن</th>
                            <th>مبلغ نهایی (ریال)</th>
                            <th>تخفیف</th>
                            <th>وضعیت</th>
                            <th>تاریخ ایجاد</th>
                            <th>تاریخ پرداخت</th>
                            <th>توضیحات</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var payment in Model.Payments)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex flex-column">
                                        <strong>@(payment.GatewayTrackId ?? "-")</strong>
                                        @if (!string.IsNullOrWhiteSpace(payment.ReferenceCode))
                                        {
                                            <small class="text-muted">ارجاع: @payment.ReferenceCode</small>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <strong>@payment.CustomerName</strong>
                                        <small class="text-muted">@(!string.IsNullOrWhiteSpace(payment.UserName) ? payment.UserName : payment.Email ?? "-")</small>
                                    </div>
                                </td>
                                <td>@(string.IsNullOrWhiteSpace(payment.PlanId) ? "-" : payment.PlanId)</td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <strong>@payment.FinalAmount.ToString("N0")</strong>
                                        @if (payment.Amount != payment.FinalAmount)
                                        {
                                            <small class="text-muted">@payment.Amount.ToString("N0") قبل از تخفیف</small>
                                        }
                                    </div>
                                </td>
                                <td>
                                    @if (!string.IsNullOrWhiteSpace(payment.DiscountCode))
                                    {
                                        <div class="d-flex flex-column">
                                            <strong>@payment.DiscountCode</strong>
                                            @if (payment.DiscountAmount is not null)
                                            {
                                                <small class="text-muted">@payment.DiscountAmount.Value.ToString("N0")-</small>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    <span class="badge @payment.StatusBadgeClass">@payment.StatusLabel</span>
                                </td>
                                <td>@payment.CreatedAtUtc.ConvertMiladiToShamsiWithTime()</td>
                                <td>
                                    @if (payment.PaidAtUtc is not null)
                                    {
                                        @payment.PaidAtUtc.Value.ConvertMiladiToShamsiWithTime()
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="text-truncate" style="max-width: 220px;" title="@payment.Description">@(!string.IsNullOrWhiteSpace(payment.Description) ? payment.Description : "-")</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
                @if (Model.TotalPages > 1)
                {
                    <nav aria-label="صفحات پرداخت" class="p-3 admin-pagination">
                        <ul class="pagination justify-content-end mb-0">
                            <li class="page-item @(Model.CurrentPage <= 1 ? "disabled" : string.Empty)">
                                <a class="page-link"
                                   asp-action="Index"
                                   asp-route-page="@(Model.CurrentPage - 1)"
                                   asp-route-pageSize="@Model.PageSize"
                                   asp-route-search="@Model.SearchTerm"
                                   asp-route-status="@((int?)Model.SelectedStatus)"
                                   asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                                   asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
                                   asp-route-userName="@Model.UserName">قبلی</a>
                            </li>
                            @for (var i = startPage; i <= endPage; i++)
                            {
                                <li class="page-item @(i == Model.CurrentPage ? "active" : string.Empty)">
                                    <a class="page-link"
                                       asp-action="Index"
                                       asp-route-page="@i"
                                       asp-route-pageSize="@Model.PageSize"
                                       asp-route-search="@Model.SearchTerm"
                                       asp-route-status="@((int?)Model.SelectedStatus)"
                                       asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                                       asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
                                       asp-route-userName="@Model.UserName">@i</a>
                                </li>
                            }
                            <li class="page-item @(Model.CurrentPage >= Model.TotalPages ? "disabled" : string.Empty)">
                                <a class="page-link"
                                   asp-action="Index"
                                   asp-route-page="@(Model.CurrentPage + 1)"
                                   asp-route-pageSize="@Model.PageSize"
                                   asp-route-search="@Model.SearchTerm"
                                   asp-route-status="@((int?)Model.SelectedStatus)"
                                   asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                                   asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
                                   asp-route-userName="@Model.UserName">بعدی</a>
                            </li>
                        </ul>
                    </nav>
                }
            }
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/persian-datepicker.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/persian-datepicker.js" asp-append-version="true"></script>
    <script>
        (function () {
            if (window.PersianDatePicker && typeof window.PersianDatePicker.init === 'function') {
                window.PersianDatePicker.init();
            }
        })();
    </script>
}
